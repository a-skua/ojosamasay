package ojosama

import (
	"fmt"
	"golang.org/x/text/width"
	"strings"
)

const ojosama = `
     \                        .......
      \                  ....##########=...
                       ...#""".........###_...
                     ...#".............,....\...
                    .../.............####+...\...
                   .../............/""""++....\..
           \\\\\\\/../............/      \+....|..
            ####/##\....;.;.;...."        |....|...
          /#####\##/"...;.|.\.|...|   ,,,,|;...;...
          \######/..;...:/\/\.|\..\ '"    //...;.:.
            \###/|..;.\.|,"\"=,\ \|\  ,.==.//..;.;:.
             ""/#'..;.\  ' :$$'      '$$: ";/.;.;.;.
            /##/;.;..\.\                   '/./.;.;..
          /###/.;;./\..\.\..            .././..;..;.;.
         /##/ .;.##\;....\...  ,...,     /..../..;..;.
         #/  / ;..##\/::::::.   '''    /...;.::##../\.
        |/: ; /...#####++##+":.     .::+++.....#+.. /.
        ::::....+#/:+##+:::+.::'::'::...+######+...;..\
         \::::.....+':......:/::::::::#+....+#,:#,.....;
          /\::::/''\........:...::....\.......+..#+..../
         /.../      \:......:''.:..'''/......./\...../  \
       /../##+\     /\::'...:         /....../"'  \:..\   \
     /.../#####+\ /##\:...,+'  $$    /::+..../     \:..\  |\
    /.+"./\###########\../##,###+'####/':::.|#\    /#\...\|.|
/""../:::::\####/ \####\/...\/+++\##/...."/"##\/######\  \...\\
....\:::::::::"'\ /'\##/../:::"|"::|::....|#/  \#######\...;;...\
....\:::::::::/"   /  |\.::..::|:::#\:::/"  |  /######+:;;........\
.....|:::::::::\  /  |   "";;;;#;;;;;::". |  /\::::::::.............;
.....::::::::::::::\     /:::::#:::::/    |   /::::::::\.......;/:: ;
`

func bubble(txt string) string {
	s := size(txt)
	top, bottom := "", ""
	for i := 0; i < s; i++ {
		top += "_"
		bottom += "-"
	}

	return fmt.Sprintf(strings.Join([]string{
		" _%s_",
		"< %s >",
		" -%s-",
	}, "\n"), top, txt, bottom)
}

func size(txt string) int {
	s := 0
	for _, r := range txt {
		p := width.LookupRune(r)
		switch p.Kind() {
		case width.EastAsianWide,
			width.EastAsianFullwidth:
			s += 2
		default:
			s += 1
		}
	}
	return s
}

func Say(txt string) string {
	txt = strings.ReplaceAll(strings.TrimSpace(txt), "\n", " ")
	return bubble(txt) + ojosama
}
